<div class="ui-g ui-fluid">
    <div class="ui-g-12 ui-md-12 ui-sm-12">
        <div class="card card-w-title">
            <h1>Validação</h1>
            <div class="ui-g">
                <div class="ui-g-4 ui-md-4 ui-sm-12">
                    <span class="md-inputfield">
                        <input type="text" pInputText class="ui-inputtext"
                            [(ngModel)]="searchDivergence.identificadorAnalise" (keyup.enter)="performSearch()"
                            id="idIdentificadorComponentAnalise" maxlength="50">
                        <label>Identificador</label>
                    </span>
                </div>
                <div class="ui-g-4 ui-md-4 ui-sm-12">
                    <p-dropdown [filter]="true" [options]="nomeSistemas" optionLabel="nome"
                        id="idNomeSistemaComponentAnalise" [(ngModel)]="searchDivergence.sistema" [autoWidth]="false"
                        [placeholder]="this.getLabel('Sistema')">
                    </p-dropdown>
                </div>
                <div class="ui-g-4 ui-md-4 ui-sm-12">
                    <p-dropdown id="idOrganizacaoComponentAnalise" [filter]="true" [options]="organizations"
                        optionLabel="nome" [autoWidth]="false" [(ngModel)]="searchDivergence.organizacao"
                        [placeholder]="this.getLabel('Organização')">
                    </p-dropdown>
                </div>
                <div class="ui-g-4 ui-md-4 ui-sm-12">
                    <p-dropdown id="idStatusComponentAnalise" [filter]="true" [options]="lstStatus" optionLabel="nome"
                        [autoWidth]="false" [(ngModel)]="searchDivergence.status"
                        [placeholder]="this.getLabel('Status')">
                    </p-dropdown>
                </div>
                <div class="ui-g-4 ui-md-4 ui-sm-12">
                    <p-dropdown id="idBloqueadoComponentAnalise" [filter]="true" [options]="bloquear"
                        optionLabel="titulo" [autoWidth]="false" [(ngModel)]="searchDivergence.bloqueiaAnalise"
                        [placeholder]="this.getLabel('Bloqueado')">
                    </p-dropdown>
                </div>
            </div>
            <div class="ui-g">
                <div class="ui-g ui-md-12" style="justify-content: center; margin-bottom: 25px; margin-top: 25px">
                    <div class="ui-g-2 ui-md-2 ui-sm-12">
                        <app-white-button [buttonLabel]="'Limpar pesquisa' " id="idBtnLimparPesquisaComponentAnalise"
                            buttonIcon="ui-icon-clear-all" (click)="limparPesquisa()">
                        </app-white-button>
                    </div>
                    <div class="ui-g-2 ui-md-2 ui-sm-12">
                        <app-blue-button *ngIf="canPesquisar" [buttonLabel]="'Pesquisar' "
                            id="idBtnPesquisarComponentAnalise" buttonIcon="ui-icon-search" (click)="performSearch()">
                        </app-blue-button>
                    </div>
                </div>
                <div style="width: -webkit-fill-available;">

                    <div>

                        <div class="ui-g-12 ui-md-11">
                            <p-table dataKey="id" [columns]="columnsVisible" [value]="lstDivergence" [lazy]="true"
                                [paginator]="true" selectionMode="multiple" [rows]="rows"
                                (onPage)="onPageChange($event)" [rowsPerPageOptions]="rowsPerPageOptions"
                                [metaKeySelection]="true" (click)="selectAnalise()" (dblclick)="onRowDblclick($event)"
                                [(selection)]="selectedDivergence" [showCurrentPageReport]="true" [autoLayout]="true"
                                currentPageReportTemplate='Registros {first} a {last} de {totalRecords}' #data>
                                <ng-template pTemplate="caption" class="valid">
                                    Validação
                                </ng-template>
                                <ng-template pTemplate="header" let-columns>
                                    <tr>
                                        <th></th>
                                        <th pSortableColumn="organizacao.nome">Organização<p-sortIcon
                                                field="organizacao.nome"></p-sortIcon></th>
                                        <th pSortableColumn="identificadorAnalise">Identificador da
                                            Validação<p-sortIcon field="identificadorAnalise"></p-sortIcon></th>
                                        <th pSortableColumn="sistema.nome">Sistema<p-sortIcon
                                                field="sistema.nome"></p-sortIcon></th>
                                        <th pSortableColumn="metodoContagem">Metodo Contagem<p-sortIcon
                                                field="metodoContagem"></p-sortIcon></th>
                                        <th pSortableColumn="pfTotalOriginal">PF Ajustado Original<p-sortIcon
                                                field="pfTotalOriginal"></p-sortIcon></th>
                                        <th pSortableColumn="pfTotalAprovado">PF Ajustado Aprovado<p-sortIcon
                                                field="pfTotalAprovado"></p-sortIcon></th>
                                        <th pSortableColumn="dataCriacaoOrdemServico">Data de criação<p-sortIcon
                                                field="dataCriacaoOrdemServico"></p-sortIcon></th>
                                        <th pSortableColumn="status">Status<p-sortIcon field="status"></p-sortIcon>
                                        </th>
                                        <th pSortableColumn="bloqueiaAnalise">Bloqueado<p-sortIcon
                                                field="bloqueiaAnalise"></p-sortIcon></th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-rowData let-expanded="expanded" let-columns="columns"
                                    let-rowIndex="rowIndex">
                                    <tr [pSelectableRow]="rowData" [pSelectableRowIndex]="rowIndex">
                                        <td>
                                            <a href="#" [pRowToggler]="rowData">
                                                <i
                                                    [ngClass]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"></i>
                                            </a>
                                        </td>
                                        <td>
                                            {{rowData.organizacao.nome}}
                                        </td>
                                        <td>
                                            {{rowData.identificadorAnalise}}
                                        </td>
                                        <td>
                                            {{rowData.sistema.nome}}
                                        </td>
                                        <td>
                                            {{rowData.metodoContagem}}
                                        </td>
                                        <td>
                                            {{
                                            ((rowData.pfTotalOriginal || rowData.analisesComparadas[0]?.pfTotal) |
                                            number:
                                            '1.2-2')?.replace(".", ",")
                                            }}
                                        </td>
                                        <td>
                                            {{ ((rowData.pfTotalAprovado) | number: '1.2-2')?.replace(".", ",") }}
                                        </td>
                                        <td>
                                            {{rowData.dataCriacaoOrdemServico | date: 'dd/MM/y - HH:mm' }}
                                        </td>
                                        <td>
                                            {{rowData.status?.nome }}
                                        </td>
                                        <td>
                                            {{rowData.bloqueiaAnalise ? 'Sim' : 'Não' }}
                                        </td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="rowexpansion" let-rowData let-columns="columns">
                                    <tr style="background: rgba(50, 74, 94, 0.1) !important;">
                                        <td [attr.colspan]="columns.length + 1">
                                            <div class="p-grid -fluid" style="font-size:16px;padding:20px">
                                                <div class="ui-g">
                                                    <div class="ui-g-12 ui-md-6"
                                                        *ngFor="let comp of rowData.analisesComparadas">
                                                        <div class="ui-g-12">
                                                            <b>Equipe:</b> {{comp.equipeResponsavel.nome}}
                                                        </div>
                                                        <div class="ui-g-12">
                                                            <b>Identificador:</b> {{comp.identificadorAnalise}}
                                                        </div>
                                                        <div class="ui-g-12">
                                                            <b>Número Os.:</b> {{comp.numeroOs}}
                                                        </div>
                                                        <div class="ui-g-12">
                                                            <b>PF Total:</b> {{comp.pfTotal}}
                                                        </div>
                                                        <div class="ui-g-12">
                                                            <b>PF Ajustado:</b> {{comp.adjustPFTotal}}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                        <div class="ui-g-12 ui-md-1">
                            <basis-datatable-button *ngIf="canPesquisar && !selectModeButtonsMultiple"
                                [bTooltip]="'Visualizar'" name="visualizarDivergencia" icon="remove-red-eye"
                                [disabled]="!selectedDivergence" (click)="viewDivergence(selectedDivergence[0])">
                            </basis-datatable-button>
                            <basis-datatable-button *ngIf="canEditar && !selectModeButtonsMultiple"
                                name="generateDivergence" icon="edit" [disabled]="!selectedDivergence"
                                (click)="editDivergence(selectedDivergence[0])" class="ui-button-info">
                            </basis-datatable-button>
                            <basis-datatable-button *ngIf="canDeletar && !selectModeButtonsMultiple"
                                name="generateDivergence" icon="delete" [disabled]="!selectedDivergence"
                                (click)="confirmDeleteDivergence(selectedDivergence[0])" class="ui-button-danger">
                            </basis-datatable-button>
                            <basis-datatable-button *ngIf="blocked && canBloquearDesbloquear" name="blockDivergence"
                                [bTooltip]="selectedDivergence != null ? 'Desbloquear' : 'Escolha um registro para desbloquear.'"
                                icon="block" [disabled]="!selectedDivergence"
                                (click)="confirmBlockDivegence(selectedDivergence[0])" class="ui-button-success">
                            </basis-datatable-button>
                            <basis-datatable-button *ngIf="!blocked && inicial && canBloquearDesbloquear"
                                name="unlockDivergemce"
                                [bTooltip]="selectedDivergence != null ? 'Bloquear' : 'Escolha um registro para bloquear.'"
                                icon="block" [disabled]="!selectedDivergence"
                                (click)="confirmBlockDivegence(selectedDivergence[0])" class="ui-button-danger">
                            </basis-datatable-button>
                            <basis-datatable-button *ngIf="canAlterarStatus && !selectModeButtonsMultiple"
                                name="generateDivergence"
                                [bTooltip]="selectedDivergence != null ? 'Alterar' : 'Escolha um registro para alterar status.'"
                                icon="swap-vert" [disabled]="!selectedDivergence"
                                (click)="changeStatus(selectedDivergence[0])" class="ui-button-info">
                            </basis-datatable-button>
                        </div>
                        <div class="ui-g-12 ui-md-2">
                            <app-export-button [dataTable]="datatable" resourceName="divergencia"
                                [filter]="searchDivergence" funcionalidadeName="divergencia">
                            </app-export-button>
                        </div>
                        <!-- Dialog confirmação deleção -->
                        <p-confirmDialog [header]="this.getLabel('Confirmação')" #dialog>
                            <p-footer>
                                <button type="button" pButton icon="fa-close" [label]="'Não'"
                                    (click)="dialog.reject()"></button>
                                <button type="button" pButton icon="fa-check" [label]="'Sim'"
                                    (click)="dialog.accept()"></button>
                            </p-footer>
                        </p-confirmDialog>
                        <!-- Dialog bloquear e alterar status validação-->
                        <p-dialog header="Alterar status para bloquear / desbloquear?"
                            [(visible)]="showDialogDivergenceBlock" [style]="{width: '40vw', minHeight: '200px'}"
                            [modal]="true">
                            <div style="min-height:200px">
                                <div class="ui-g">
                                    <div class="ui-g-12 ui-md-12 ui-sm-12">
                                        <p-dropdown [style]="{'width':'100%'}" [filter]="true" dataKey=id
                                            optionLabel="nome" [options]="lstStatusActive" id="idStatusAnalise"
                                            [(ngModel)]="statusToChange" placeholder="Selecione um Status">
                                        </p-dropdown>
                                    </div>
                                </div>
                                <app-green-button *ngIf="blocked" buttonLabel="Desbloquear" (click)="divergenceBlock()"
                                    style="float:right; margin-top: 5px"></app-green-button>
                                <app-red-button *ngIf="!blocked" buttonLabel="Bloquear" (click)="divergenceBlock()"
                                    style="float:right; margin-top: 5px"></app-red-button>
                            </div>
                        </p-dialog>
                        <!-- Dialog Alterar status validação-->
                        <p-dialog header="Alterar status ?" [(visible)]="showDialogDivergenceStatus"
                            [style]="{width: '40vw', minHeight: '200px'}" [modal]="true">
                            <div style="min-height:200px">
                                <div class="ui-g">
                                    <div class="ui-g-12 ui-md-12 ui-sm-12">
                                        <p-dropdown [style]="{'width':'100%'}" [filter]="true" dataKey=id
                                            optionLabel="nome" [options]="lstStatusActive" id="idStatusAnalise"
                                            [(ngModel)]="statusToChange" placeholder="Selecione um Status">
                                        </p-dropdown>
                                    </div>
                                </div>
                                <app-green-button buttonLabel="Alterar" (click)="alterStatusValidacao()"
                                    style="float:right; margin-top: 5px"></app-green-button>
                            </div>
                        </p-dialog>

                    </div>
                </div>
            </div>
        </div>
    </div>